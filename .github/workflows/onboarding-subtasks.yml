name: Create Onboarding Sub-Tasks

on:
  issues:
    types: [labeled]

permissions:
  issues: write

jobs:
  create-subtasks:
    if: github.event.label.name == 'begin-onboarding'
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Check if the label was added by a team lead
        id: check_team_lead
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const actor = context.actor;
            let teamLeadsData = {};
            try {
              teamLeadsData = JSON.parse(fs.readFileSync('.github/team-leads.json', 'utf8'));
            } catch (e) {
              core.setFailed(`Failed to load team leads: ${e.message}`);
              return;
            }
            const labelNames = issue.labels.map(label => label.name.toLowerCase());
            let isTeamLead = false, assignedTeam = null;
            for (const [team, leads] of Object.entries(teamLeadsData)) {
              if (labelNames.includes(team)) {
                assignedTeam = team;
                if (leads.map(s => s.toLowerCase()).includes(actor.toLowerCase())) {
                  isTeamLead = true;
                  break;
                }
              }
            }
            core.setOutput('isTeamLead', isTeamLead ? 'true' : 'false');
            core.setOutput('assignedTeam', assignedTeam);
            core.setOutput('actor', actor);

      - name: Comment if not a team lead
        if: steps.check_team_lead.outputs.isTeamLead == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const assignedTeam = "${{ steps.check_team_lead.outputs.assignedTeam }}";
            let message;
            if (assignedTeam) {
              message = `⚠️ Only a team lead for \`${assignedTeam}\` should assign the \`begin-onboarding\` label. If this was a mistake, please remove the label.`;
            } else {
              message = "⚠️ Only a relevant team lead should assign the `begin-onboarding` label. If this was a mistake, please remove the label.";
            }
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Create sub-issues and link as children
        if: steps.check_team_lead.outputs.isTeamLead == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const parentIssue = context.payload.issue;
            const parentIssueNumber = parentIssue.number;

            // Original poster (issue creator)
            const opener = parentIssue.user.login;

            // Team lead (the actor who added the label and was validated)
            const teamLeadAssignee = "${{ steps.check_team_lead.outputs.actor }}";

            const labelNames = parentIssue.labels.map(label => label.name.toLowerCase());

            // Per-task assignment rule:
            // assignTo: "op"   -> assign to original poster
            // assignTo: "lead" -> assign to team lead (fallback to opener if unavailable)
            // You can add more rules by extending assignmentResolvers if needed.
            const subTasksByTeam = {
              "community-team": [
                { title: "Community: Complete onboarding form", body: `Subtask of #${parentIssueNumber}`, assignTo: "op" },
                { title: "Community: Read onboarding guide", body: `Subtask of #${parentIssueNumber}`, assignTo: "lead" }
              ],
              "marketing-team": [
                { title: "Marketing: Complete onboarding form", body: `Subtask of #${parentIssueNumber}`, assignTo: "op" },
                { title: "Marketing: Join marketing Slack", body: `Subtask of #${parentIssueNumber}`, assignTo: "lead" }
              ],
              // Extend for additional teams if needed
              "default": [
                { title: "General Onboarding: Complete form", body: `Subtask of #${parentIssueNumber}`, assignTo: "op" },
                { title: "General Onboarding: Read docs", body: `Subtask of #${parentIssueNumber}`, assignTo: "lead" }
              ]
            };

            // Decide which team's sub-tasks to use
            const teamKey = Object.keys(subTasksByTeam).find(t => labelNames.includes(t)) || "default";
            const subTasks = subTasksByTeam[teamKey];

            // Resolver for assignment tokens
            function resolveAssignee(token) {
              switch (token) {
                case 'lead':
                  return teamLeadAssignee || opener;
                case 'op':
                default:
                  return opener;
              }
            }

            const createdNumbers = [];

            for (const subTask of subTasks) {
              const assignee = resolveAssignee(subTask.assignTo);

              // Create sub-issue with chosen assignee
              let newIssue;
              try {
                newIssue = await github.rest.issues.create({
                  ...context.repo,
                  title: subTask.title,
                  body: subTask.body,
                  labels: parentIssue.labels.map(l => l.name),
                  assignees: [assignee]
                });
              } catch (e) {
                // Fallback if assignee cannot be set (e.g., not a collaborator)
                core.warning(`Failed to assign "${assignee}" to "${subTask.title}" (${e.status || e.message}). Retrying without assignee.`);
                newIssue = await github.rest.issues.create({
                  ...context.repo,
                  title: subTask.title,
                  body: subTask.body,
                  labels: parentIssue.labels.map(l => l.name)
                });
              }

              const childNumber = newIssue.data.number;
              const childId = newIssue.data.id;
              createdNumbers.push(childNumber);

              // Link as sub-issue using official endpoint (requires issue id, not number)
              try {
                await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/sub_issues', {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parentIssueNumber,
                  sub_issue_id: childId,
                  replace_parent: false
                });
              } catch (linkErr) {
                core.warning(`Failed to link sub-issue #${childNumber}: ${linkErr.message}`);
              }
            }

            // Optional checklist appended to parent issue body
            const checklist = createdNumbers.map(n => `- [ ] #${n}`).join('\n');
            const updatedBody = `${parentIssue.body || ""}\n\n### Onboarding Tasks\n${checklist}`;
            await github.rest.issues.update({
              ...context.repo,
              issue_number: parentIssueNumber,
              body: updatedBody
            });

            core.info(`Created and linked ${createdNumbers.length} sub-issues for team "${teamKey}".`)