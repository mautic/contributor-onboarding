name: Team Leader Round-Robin Assignment

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write

jobs:
  assign-team-leader:
    runs-on: ubuntu-latest
    if: >
      contains(github.event.issue.labels.*.name, 'community-team') || 
      contains(github.event.issue.labels.*.name, 'education-team') || 
      contains(github.event.issue.labels.*.name, 'marketing-team') || 
      contains(github.event.issue.labels.*.name, 'product-team') ||
      contains(github.event.issue.labels.*.name, 'ambassador') ||
      contains(github.event.issue.labels.*.name, 'council-member')
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Check and create variables if needed
        run: |
          gh variable list -R ${{ github.repository }} | grep -q "LAST_ASSIGNED_COMMUNITY_TEAM" || \
            gh variable set LAST_ASSIGNED_COMMUNITY_TEAM -R ${{ github.repository }} -b "0"
          gh variable list -R ${{ github.repository }} | grep -q "LAST_ASSIGNED_EDUCATION_TEAM" || \
            gh variable set LAST_ASSIGNED_EDUCATION_TEAM -R ${{ github.repository }} -b "0"
          gh variable list -R ${{ github.repository }} | grep -q "LAST_ASSIGNED_MARKETING_TEAM" || \
            gh variable set LAST_ASSIGNED_MARKETING_TEAM -R ${{ github.repository }} -b "0"
          gh variable list -R ${{ github.repository }} | grep -q "LAST_ASSIGNED_PRODUCT_TEAM" || \
            gh variable set LAST_ASSIGNED_PRODUCT_TEAM -R ${{ github.repository }} -b "0"
          gh variable list -R ${{ github.repository }} | grep -q "LAST_ASSIGNED_AMBASSADOR" || \
            gh variable set LAST_ASSIGNED_AMBASSADOR -R ${{ github.repository }} -b "0"
          gh variable list -R ${{ github.repository }} | grep -q "LAST_ASSIGNED_COUNCIL_MEMBER" || \
            gh variable set LAST_ASSIGNED_COUNCIL_MEMBER -R ${{ github.repository }} -b "0"
        env:
          GH_TOKEN: ${{ secrets.REPO_PAT }}

      - name: Assign team leader
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REPO_PAT }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const issue = context.payload.issue;
            if (!issue) return;

            const teamLeadsPath = path.join('.github', 'team-leads.json');
            let teamLeaders = {};
            try {
              teamLeaders = JSON.parse(fs.readFileSync(teamLeadsPath, 'utf8'));
            } catch (e) {
              core.setFailed(`Failed to load team leads: ${e.message}`);
              return;
            }

            const labelNames = issue.labels.map(label => label.name.toLowerCase());
            const matchingTeam = Object.keys(teamLeaders).find(team => labelNames.includes(team));

            if (matchingTeam) {
              const leaders = teamLeaders[matchingTeam];
              const varName = `LAST_ASSIGNED_${matchingTeam.replace(/-/g, '_').toUpperCase()}`;
              const { execSync } = require('child_process');
              let currentIndex = 0;
              try {
                const output = execSync(`gh variable get ${varName} -R ${process.env.GITHUB_REPOSITORY}`, { 
                  encoding: 'utf8',
                  env: {
                    ...process.env,
                    GH_TOKEN: process.env.GITHUB_TOKEN
                  }
                });
                currentIndex = parseInt(output.trim()) || 0;
                core.info(`Current index for ${varName}: ${currentIndex}`);
              } catch (error) {
                core.info(`Could not get variable ${varName}, using default 0`);
              }

              // Calculate next index
              const nextIndex = (currentIndex + 1) % leaders.length;

              // Set variable to next index
              execSync(`gh variable set ${varName} -R ${process.env.GITHUB_REPOSITORY} -b "${nextIndex}"`, {
                env: {
                  ...process.env,
                  GH_TOKEN: process.env.GITHUB_TOKEN
                }
              });

              // Assign the issue to the selected team lead
              const assignee = leaders[currentIndex];
              await github.rest.issues.addAssignees({
                ...context.repo,
                issue_number: issue.number,
                assignees: [assignee]
              });
              core.info(`Assigned ${assignee} to issue #${issue.number}`);
            }