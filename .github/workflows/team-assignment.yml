name: Team Leader Round-Robin Assignment

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  issues: write

jobs:
  assign-team-leader:
    runs-on: ubuntu-latest
    if: >
      contains(github.event.issue.labels.*.name, 'community-team') ||
      contains(github.event.issue.labels.*.name, 'education-team') ||
      contains(github.event.issue.labels.*.name, 'marketing-team') ||
      contains(github.event.issue.labels.*.name, 'product-team') ||
      contains(github.event.issue.labels.*.name, 'ambassador') ||
      contains(github.event.issue.labels.*.name, 'council-member')

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Assign team leader (round-robin via repo variables)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REPO_PAT }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            if (!issue) {
              core.info('No issue in payload, exiting.');
              return;
            }

            // Load team leads config
            const teamLeadsPath = path.join('.github', 'team-leads.json');
            let teamLeaders = {};
            try {
              teamLeaders = JSON.parse(fs.readFileSync(teamLeadsPath, 'utf8'));
            } catch (e) {
              core.setFailed(`Failed to load team leads from ${teamLeadsPath}: ${e.message}`);
              return;
            }

            // Determine which team label applies to this issue
            const labelNames = (issue.labels || []).map(l => (l.name || '').toLowerCase());
            const knownTeams = Object.keys(teamLeaders); // e.g., ['community-team', ...]
            const matchingTeam = knownTeams.find(team => labelNames.includes(team));

            if (!matchingTeam) {
              core.info('No matching team label found on the issue. Nothing to assign.');
              return;
            }

            const leaders = teamLeaders[matchingTeam] || [];
            if (!leaders.length) {
              core.setFailed(`No team leads configured for team "${matchingTeam}".`);
              return;
            }

            // Map team name to variable name (replace '-' with '_', uppercase, and prefix)
            const varName = `LAST_ASSIGNED_${matchingTeam.replace(/-/g, '_').toUpperCase()}`;

            // Helper functions to read/update repo variables via REST (no gh CLI)
            async function getRepoVariable(name) {
              try {
                const res = await github.request('GET /repos/{owner}/{repo}/actions/variables/{name}', {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name
                });
                return res.data; // { name, value, ... }
              } catch (error) {
                if (error.status === 404) return null;
                throw error;
              }
            }

            async function createRepoVariable(name, value) {
              await github.request('POST /repos/{owner}/{repo}/actions/variables', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                name,
                value: String(value)
              });
            }

            async function updateRepoVariable(name, value) {
              await github.request('PATCH /repos/{owner}/{repo}/actions/variables/{name}', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                name,
                value: String(value)
              });
            }

            // Read current index (default to 0 if missing)
            let currentIndex = 0;
            const existingVar = await getRepoVariable(varName);
            if (existingVar && typeof existingVar.value === 'string') {
              const parsed = parseInt(existingVar.value.trim(), 10);
              if (!Number.isNaN(parsed)) currentIndex = parsed;
            } else if (!existingVar) {
              // Create it at 0 if it doesn't exist
              await createRepoVariable(varName, '0');
              core.info(`Initialized repo variable ${varName} to 0.`);
            }

            // Choose assignee and compute next index
            const assignee = leaders[currentIndex % leaders.length];
            const nextIndex = (currentIndex + 1) % leaders.length;

            // Assign the issue to the selected team lead
            await github.rest.issues.addAssignees({
              ...context.repo,
              issue_number: issue.number,
              assignees: [assignee]
            });
            core.info(`Assigned ${assignee} to issue #${issue.number} for team "${matchingTeam}".`);

            // Persist next index back to repo variable
            try {
              if (existingVar) {
                await updateRepoVariable(varName, String(nextIndex));
              } else {
                // If it didn't exist earlier (we initialized), ensure it's set to the next index now
                await updateRepoVariable(varName, String(nextIndex));
              }
              core.info(`Updated ${varName} to ${nextIndex}.`);
            } catch (e) {
              core.setFailed(`Failed to update repo variable ${varName}: ${e.message}`);
              return;
            }