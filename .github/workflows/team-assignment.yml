name: Team Leader Round-Robin Assignment

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write

jobs:
  assign-team-leader:
    runs-on: ubuntu-latest
    if: >-
      contains(github.event.issue.labels.*.name, 'community-team') ||
      contains(github.event.issue.labels.*.name, 'education-team') ||
      contains(github.event.issue.labels.*.name, 'marketing-team') ||
      contains(github.event.issue.labels.*.name, 'product-team') ||
      contains(github.event.issue.labels.*.name, 'ambassador') ||
      contains(github.event.issue.labels.*.name, 'council-member')
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Check and create variables if needed
        env:
          REPO_PAT: ${{ secrets.REPO_PAT }}   # keep the secret available for the auth step
          GH_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          # auth gh CLI with the PAT from the secret
          echo "${{ secrets.REPO_PAT }}" | gh auth login --with-token

          for var in LAST_ASSIGNED_COMMUNITY_TEAM LAST_ASSIGNED_EDUCATION_TEAM LAST_ASSIGNED_MARKETING_TEAM LAST_ASSIGNED_PRODUCT_TEAM LAST_ASSIGNED_AMBASSADOR LAST_ASSIGNED_COUNCIL_MEMBER; do
            if ! gh variable list -R "${{ github.repository }}" | grep -q "$var"; then
              gh variable set "$var" -R "${{ github.repository }}" -b "0"
            fi
          done

          gh variable list -R "${{ github.repository }}" | grep -q "LAST_ASSIGNED_COMMUNITY_TEAM" || \
            gh variable set LAST_ASSIGNED_COMMUNITY_TEAM -R "${{ github.repository }}" -b "0"
          gh variable list -R "${{ github.repository }}" | grep -q "LAST_ASSIGNED_EDUCATION_TEAM" || \
            gh variable set LAST_ASSIGNED_EDUCATION_TEAM -R "${{ github.repository }}" -b "0"
          gh variable list -R "${{ github.repository }}" | grep -q "LAST_ASSIGNED_MARKETING_TEAM" || \
            gh variable set LAST_ASSIGNED_MARKETING_TEAM -R "${{ github.repository }}" -b "0"
          gh variable list -R "${{ github.repository }}" | grep -q "LAST_ASSIGNED_PRODUCT_TEAM" || \
            gh variable set LAST_ASSIGNED_PRODUCT_TEAM -R "${{ github.repository }}" -b "0"
          gh variable list -R "${{ github.repository }}" | grep -q "LAST_ASSIGNED_AMBASSADOR" || \
            gh variable set LAST_ASSIGNED_AMBASSADOR -R "${{ github.repository }}" -b "0"
          gh variable list -R "${{ github.repository }}" | grep -q "LAST_ASSIGNED_COUNCIL_MEMBER" || \
            gh variable set LAST_ASSIGNED_COUNCIL_MEMBER -R "${{ github.repository }}" -b "0"

      - name: Assign team leader
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.REPO_PAT }}
        with:
          github-token: ${{ secrets.REPO_PAT }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const issue = context.payload.issue;
            if (!issue) return;

            const teamLeadsPath = path.join('.github', 'team-leads.json');
            let teamLeaders = {};
            try {
              teamLeaders = JSON.parse(fs.readFileSync(teamLeadsPath, 'utf8'));
            } catch (e) {
              core.setFailed(`Failed to load team leads: ${e.message}`);
              return;
            }

            const labelNames = issue.labels.map(label => label.name.toLowerCase());
            const matchingTeam = Object.keys(teamLeaders).find(team => labelNames.includes(team));

            if (!matchingTeam) return;

            const leaders = teamLeaders[matchingTeam];
            const varName = `LAST_ASSIGNED_${matchingTeam.replace(/-/g, '_').toUpperCase()}`;

            // Use Octokit to get/set the repository variable (authenticated with the provided PAT)
            let currentIndex = 0;
            try {
              const getRes = await github.request('GET /repos/{owner}/{repo}/actions/variables/{name}', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: varName
              });
              // API returns the variable value in getRes.data.value when authorized
              currentIndex = parseInt(getRes.data.value || '0', 10) || 0;
              core.info(`Current index for ${varName}: ${currentIndex}`);
            } catch (err) {
              core.info(`Could not get variable ${varName}, using default 0 (${err.message})`);
            }

            const nextIndex = (currentIndex + 1) % leaders.length;

            try {
              await github.request('PUT /repos/{owner}/{repo}/actions/variables/{name}', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: varName,
                value: String(nextIndex)
              });
              core.info(`Set ${varName} -> ${nextIndex}`);
            } catch (err) {
              core.error(`Failed to set variable ${varName}: ${err.message}`);
              core.setFailed(err.message);
              return;
            }

            // Assign the issue to the selected team lead (use currentIndex so round-robin chooses previous+1)
            const assignee = leaders[currentIndex];
            await github.rest.issues.addAssignees({
              ...context.repo,
              issue_number: issue.number,
              assignees: [assignee]
            });
            core.info(`Assigned ${assignee} to issue #${issue.number}`);
